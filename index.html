<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>L.O.T.U.S</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸª·</text></svg>">
<style>
    body { background:#0f1724; color:#fff; font-family:sans-serif; margin:0; padding:20px; }
    section { display:none; }
    .active { display:block; }
    input, textarea, select {
      background:#1d2738; border:1px solid #2c3a52; color:#fff; padding:8px;
      border-radius:8px; margin-bottom:12px; box-sizing:border-box;
    }
    select option { color:#000; background:#fff; }
    .login-box input {
      background:#3a4a5f;
      border:1px solid #4a5a6f;
    }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:16px; table-layout:fixed; }
    th, td {
      border-bottom:1px solid #2a3548; padding:12px 8px; vertical-align:middle;
      color:#e2e8f0; overflow:hidden; text-overflow:ellipsis;
    }
    th:nth-child(1), td:nth-child(1) { width:80px; text-align:left; }
    th:nth-child(2), td:nth-child(2) {
      width:600px;
      white-space:normal;
      word-break:break-word;
      text-align:left;
    }
    th:nth-child(3), td:nth-child(3) { width:200px; text-align:left; }
    th:nth-child(4), td:nth-child(4) { width:200px; text-align:left; }
    th:nth-child(5), td:nth-child(5) { width:120px; text-align:left; }
    tr:hover { background:#1a2536; }
    .btn { padding:8px 12px; background:#1e90ff; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    #new, #detail-content { max-width: 800px; margin: 0 auto; padding: 0 20px; }
    input, textarea { width: 100%; }
    #new input, #new textarea, #new select { display:block; width:100%; margin-bottom:12px; }
    select.short-select { width:auto; min-width:120px; max-width:200px; display:inline-block; }
    #new label { display:block; margin-top:8px; margin-bottom:4px; }
    .empty-row td { text-align:center; color:#9aa4b2; white-space:normal; }
    .detail-wrap { display:flex; gap:20px; align-items:flex-start; max-width:1400px; margin: 0 auto; }
    #detail-main { flex:1; }
    #detail-content label{display:block;margin-top:10px;font-weight:bold;}
    #detail-content input,#detail-content textarea,#detail-content select{ width:100%; box-sizing:border-box; margin-top:4px; }
    .comment-section { margin-top:24px; max-width:800px; margin-left:auto; margin-right:auto; }
    .comment-list { margin-top:8px; }
    .comment-item { padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; }
    .comment-text{ white-space:pre-wrap; color:#e6eef6; }
    .comment-meta{ font-size:12px; color:#9aa4b2; }
    .collapsed-latest { font-style:italic; color:#cbd5e1; }
    #login {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      padding:20px;
    }
    .login-box {
      background:#1d2738;
      padding:32px;
      border-radius:12px;
      border:1px solid #2c3a52;
      width:100%;
      max-width:400px;
    }
    .login-box h2 {
      margin-top:0;
      text-align:center;
    }
    .login-box input {
      width:100%;
      margin-bottom:16px;
    }
    .login-box .btn {
      width:100%;
    }
    .error-msg {
      color:#ff6b6b;
      font-size:14px;
      margin-top:8px;
      text-align:center;
    }
    #loading {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(15,23,36,0.9);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #loading.show {
      display:flex;
    }
    .spinner {
      border:4px solid #2c3a52;
      border-top:4px solid #1e90ff;
      border-radius:50%;
      width:50px;
      height:50px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
    .required::after {
      content: ' *';
      color: #ff6b6b;
      font-weight: bold;
    }
    .bug-link {
      color: #1e90ff;
      text-decoration: none;
      cursor: pointer;
    }
    .bug-link:hover {
      text-decoration: underline;
    }
    /* é–¢é€£ãƒã‚±ãƒƒãƒˆé¸æŠUI */
    .related-tickets-selector {
      border: 1px solid #2c3a52;
      border-radius: 8px;
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
      background: #1d2738;
      margin-top: 4px;
    }
    .related-ticket-item {
      padding: 6px 8px;
      margin: 4px 0;
      border-radius: 4px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .related-ticket-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .related-ticket-item.selected {
      background: rgba(30,144,255,0.3);
      border: 1px solid #1e90ff;
    }
    .related-ticket-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid #2c3a52;
      border-radius: 3px;
      display: inline-block;
      position: relative;
      flex-shrink: 0;
    }
    .related-ticket-item.selected .related-ticket-checkbox {
      background: #1e90ff;
      border-color: #1e90ff;
    }
    .related-ticket-item.selected .related-ticket-checkbox::after {
      content: 'âœ“';
      position: absolute;
      top: -2px;
      left: 2px;
      color: white;
      font-size: 12px;
    }
    @media (max-width:900px){ .detail-wrap{ flex-direction:column;} }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
  </div>
  <section id="login">
    <div class="login-box">
      <h2>ğŸª·L.O.T.U.S</h2>
      <h4>Bug Tracking System</h4>
        <p>
            <font size="1">
                <i>
                    <b>L</b>ogical 
                    <b>O</b>rganization of 
                    <b>T</b>asks and 
                    <b>U</b>nresolved 
                    <b>S</b>ituations
                </i>
            </font>
        </p>
      <input id="login-userId" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" />
      <input id="login-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
      <button class="btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error-msg"></div>
    </div>
  </section>
  <nav id="main-nav" style="display:none;margin-bottom:12px;">
    <button class="btn" id="nav-list" onclick="go('#list')" style="display:none;">ä¸€è¦§</button>
    <button class="btn" id="nav-new" onclick="go('#new')">æ–°è¦ç™»éŒ²</button>
    <button class="btn" onclick="doLogout()" style="margin-left:auto;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span id="user-info" style="line-height:32px;margin-left:8px;color:#9aa4b2;"></span>
  </nav>
  <section id="list">
    <h2>ãƒã‚°ä¸€è¦§</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <input id="search" type="text" placeholder="æ¤œç´¢ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜)" style="flex:1;min-width:220px;" onkeyup="renderList()" />
    </div>
    <div class="table-wrap">
      <table id="bugTable">
        <thead>
          <tr>
            <th>No.</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>é‡è¦åº¦</th>
            <th>å„ªå…ˆåº¦</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  <section id="new">
    <h2>æ–°ã—ã„ãƒã‚°ã‚’ç™»éŒ²</h2>
    <label for="new-status" class="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select id="new-status" class="short-select" required>
      <option selected>OPEN(æ–°è¦)</option>
      <option>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
      <option>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
      <option>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
      <option>CLOSED(è§£æ¶ˆ)</option>
      <option>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
      <option>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
      <option>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
      <option>WORKSFORME(å†ç¾ã—ãªã„)</option>
      <option>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
      <option>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
      <option>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
    </select>
    <label for="new-title" class="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input id="new-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" required />
    <label for="new-desc" class="required">èª¬æ˜</label>
    <textarea id="new-desc" placeholder="ä¸å…·åˆã®å†ç¾æ‰‹é †ç­‰ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" rows="6" required></textarea>
    <label for="new-repro">å†ç¾æ€§</label>
    <input id="new-repro" placeholder="å†ç¾æ€§" />
    <label>èµ·ç¥¨è€…</label>
    <input id="new-reporter" readonly style="background:#0f1724;cursor:not-allowed;" />
    <label for="new-assignee" class="required">æ‹…å½“è€…</label>
    <input id="new-assignee" placeholder="æ‹…å½“è€…" required />
    <label for="new-severity" class="required">é‡è¦åº¦</label>
    <select id="new-severity" class="short-select" required>
      <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
      <option>S(è‡´å‘½çš„)</option>
      <option>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
      <option>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
      <option>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
      <option>D(è»½å¾®)</option>
    </select>
    <label for="new-priority" class="required">å„ªå…ˆåº¦</label>
    <select id="new-priority" class="short-select" required>
      <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
      <option>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>
    <label for="new-env">ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
    <input id="new-env" placeholder="ãƒ†ã‚¹ãƒˆç’°å¢ƒ" />
    <label for="new-version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
    <input id="new-version" placeholder="ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±" />
    <label for="new-related">é–¢é€£ãƒã‚±ãƒƒãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
    <div id="new-related-container"></div>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <button class="btn" onclick="addBug()">ç™»éŒ²</button>
      <button class="btn" onclick="go('#list')" style="background:#6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </section>
  <section id="detail">
    <div class="detail-wrap">
      <div id="detail-main">
        <div id="detail-content"></div>
        <div class="comment-section">
          <h3 style="margin-top:0;margin-bottom:8px;">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="comment-controls" style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
            <button class="btn" id="toggle-comments-btn" onclick="toggleComments(currentDetailId)">å±•é–‹/æŠ˜ç•³</button>
            <div style="flex:1;text-align:right;color:#9aa4b2;font-size:12px;">æ–°ã—ã„é †</div>
          </div>
          <div id="comment-collapsed" class="collapsed-latest" style="display:none;padding:8px;">ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div id="comment-list" class="comment-list" style="display:none;max-height:360px;overflow:auto;"></div>
          <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:8px;">
            <textarea id="comment-input" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" onclick="addComment(currentDetailId)">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
            </div>
          </div>
        </div>
        <h3 style="margin-top:24px; max-width:800px; margin-left:auto; margin-right:auto;">å¤‰æ›´å±¥æ­´</h3>
        <div id="detail-history" style="font-size:13px; color:#cbd5e1; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; max-height:200px; overflow:auto; max-width:800px; margin-left:auto; margin-right:auto;"></div>
      </div>
    </div>
  </section>
<script>
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/è‡ªèº«ã®Gasãƒ‡ãƒ—ãƒ­ã‚¤ID/exec';
  function callGAS(action, payload) {
    return fetch(GAS_ENDPOINT, {
      method: 'POST',
      body: JSON.stringify({ action, payload })
    }).then(r => r.json());
  }
  let currentUser = null;
  let bugsCache = [];
  let currentDetailId = null;
  let commentsExpanded = {};
  let isEditMode = false;
  let navigationHistory = []; 
  let originalBugData = {};
    
  function canEditDevFields() {
    if (!currentUser) return false;
    return currentUser.userType === 'admin';
  }
  function canEditBug(bug) {
    if (!currentUser) return false;
    if (currentUser.userType === 'admin') return true;
    if (currentUser.userType === 'group') return true;
    if (currentUser.userType === 'general') {
      return bug.reporter === currentUser.userId;
    }
    return false;
  }
  function showLoading() {
    document.getElementById('loading').classList.add('show');
  }
  function hideLoading() {
    document.getElementById('loading').classList.remove('show');
  }
  function doLogin() {
    const userId = document.getElementById('login-userId').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const errorEl = document.getElementById('login-error');
    if (!userId || !password) {
      errorEl.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      return;
    }
    showLoading();
    errorEl.textContent = '';
    callGAS('authenticate', { userId, password })
      .then(result => {
        hideLoading();
        if (!result.success) {
          errorEl.textContent = result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }
        currentUser = {
          userId: result.userId,
          userName: result.userName,
          userType: result.userType
        };
        document.getElementById('login').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        let userTypeLabel = '';
        if (result.userType === 'admin') {
          userTypeLabel = 'ç®¡ç†è€…';
        } else if (result.userType === 'group') {
          userTypeLabel = 'ã‚°ãƒ«ãƒ¼ãƒ—';
        } else {
          userTypeLabel = 'ä¸€èˆ¬';
        }
        document.getElementById('user-info').textContent = `${result.userName} (${userTypeLabel})`;
        loadBugsFromServer();
      })
      .catch(e => {
        hideLoading();
        errorEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
      });
  }
  function doLogout() {
    currentUser = null;
    bugsCache = [];
    location.hash = '';
    location.reload();
  }
  function loadBugsFromServer() {
    if (!currentUser) return;
    showLoading();
    callGAS('getBugs', {
      userId: currentUser.userId,
      userType: currentUser.userType
    })
      .then(result => {
        hideLoading();
        if (!result.success) {
          alert(result.message || 'èª­ã¿è¾¼ã¿å¤±æ•—');
          return;
        }
        bugsCache = result.bugs || [];
        go('#list');
        setTimeout(() => {
          window.scrollTo(0, 0);
          renderList();
        }, 100);
      })
      .catch(e => {
        hideLoading();
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
      });
  }
  function go(hash) { 
    location.hash = hash;
    window.scrollTo(0, 0);
  }
  function clearNewForm() {
    const ids = ['new-title', 'new-desc', 'new-env', 'new-version', 'new-repro', 'new-assignee'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    const reporterEl = document.getElementById('new-reporter');
    if (reporterEl && currentUser) {
      reporterEl.value = currentUser.userName;
    }
    const status = document.getElementById('new-status');
    if (status) status.value = 'OPEN(æ–°è¦)';
    const priority = document.getElementById('new-priority');
    if (priority) priority.value = '';
    const severity = document.getElementById('new-severity');
    if (severity) severity.value = '';
    populateRelatedTickets('new-related-container', null, []);
  }

  function populateRelatedTickets(containerId, currentBugId, selectedIds) {
    const container = document.getElementById(containerId);
    if (!container) return;
  
    const selected = selectedIds || [];
  
    let html = '<div class="related-tickets-selector">';
  
  // è¦‹ãˆãªã„ãƒã‚±ãƒƒãƒˆã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    const invisibleCount = selected.filter(id => !bugsCache.some(b => b.id === id)).length;
  
    if (invisibleCount > 0) {
      html += '<div style="padding:8px;color:#9aa4b2;background:rgba(255,255,255,0.05);border-radius:4px;margin-bottom:8px;">';
      html += `ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸé–¢é€£ãƒã‚±ãƒƒãƒˆ: ${invisibleCount}ä»¶ï¼ˆç·¨é›†ä¸å¯ï¼‰`;
      html += '</div>';
    }
  
    if (bugsCache.length === 0) {
      html += '<div style="padding:8px;color:#9aa4b2;">é–¢é€£ä»˜ã‘å¯èƒ½ãªãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      bugsCache.forEach(bug => {
        if (bug.id === currentBugId) return;
      
        const isSelected = selected.includes(bug.id);
        const selectedClass = isSelected ? ' selected' : '';
      
        html += '<div class="related-ticket-item' + selectedClass + '" ';
        html += 'onclick="toggleRelatedTicket(\'' + containerId + '\',\'' + bug.id + '\')">';
        html += '<span class="related-ticket-checkbox"></span>';
        html += '<span>No.' + bug.bugNo + ' - ' + escapeHtml(bug.title) + '</span>';
        html += '</div>';
      });
    }
  
    html += '</div>';
    container.innerHTML = html;
  }

function toggleRelatedTicket(containerId, bugId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const items = container.querySelectorAll('.related-ticket-item');
  items.forEach(item => {
    if (item.textContent.includes(bugId) || item.getAttribute('onclick').includes(bugId)) {
      item.classList.toggle('selected');
    }
  });
}

function getSelectedRelatedTickets(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return [];
  
  const selectedIds = [];
  const items = container.querySelectorAll('.related-ticket-item.selected');
  
  items.forEach(item => {
    const onclick = item.getAttribute('onclick');
    const match = onclick.match(/'([^']+)'\)$/);
    if (match && match[1]) {
      selectedIds.push(match[1]);
    }
  });
  
  return selectedIds;
}
  function route() {
    window.scrollTo(0, 0);
    if (!window.__booted) {
      window.__booted = true;
      document.getElementById('login').style.display = 'flex';
      document.getElementById('login').classList.add('active');
      return;
    }
    const hash = location.hash || '#list';
    const clean = hash.split('/')[0];
    if (!currentUser && clean !== '#login') {
      location.hash = '';
      return;
    }
    document.querySelectorAll('section').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });
    const pg = document.querySelector(clean);
    if (pg) {
      pg.classList.add('active');
      pg.style.display = 'block';
    }
    const navNew = document.getElementById('nav-new');
    if (navNew) {
      navNew.style.display = (clean === '#new' || clean === '#detail') ? 'none' : 'inline-block';
    }
    if (clean === '#new') {
      clearNewForm();
    }
    if (clean === '#list') {
      renderList();
    }
    if (clean === '#detail' && hash.includes('/')) {
      const bugId = hash.split('/')[1];
      showDetail(bugId);
    }
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
  function renderList() {
    const searchInput = document.getElementById('search');
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const tbody = document.querySelector('#bugTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const sorted = bugsCache.slice().sort((a, b) => (a.bugNo || 0) - (b.bugNo || 0));
    const filtered = sorted.filter(b => {
      if (!search) return true;
      const searchFields = [
        b.title || '',
        b.description || '',
        b.status || '',
        b.severity || '',
        b.priority || '',
        b.assignee || '',
        b.reporterName || ''
      ].join(' ').toLowerCase();
      return searchFields.includes(search);
    });
    if (filtered.length === 0) {
      const tr = document.createElement('tr');
      tr.className = 'empty-row';
      tr.innerHTML = '<td colspan="5">è¡¨ç¤ºã™ã‚‹é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</td>';
      tbody.appendChild(tr);
      return;
    }
    filtered.forEach((b) => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.innerHTML = `
        <td>No.${b.bugNo || '-'}</td>
        <td>${escapeHtml(b.title || '')}</td>
        <td>${escapeHtml(b.status || '')}</td>
        <td>${escapeHtml(b.severity || '')}</td>
        <td>${escapeHtml(b.priority || '')}</td>`;
      tr.addEventListener('click', () => { 
        go(`#detail/${b.id}`); 
      });
      tbody.appendChild(tr);
    });
  }
  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }
  function goToRelatedBug(bugId) {
    go(`#detail/${bugId}`);
  }

  function goBackToPrevious() {
    // å±¥æ­´ã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
    navigationHistory.pop();
  
    if (navigationHistory.length > 0) {
      // å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
      const previousBugId = navigationHistory[navigationHistory.length - 1];
      go(`#detail/${previousBugId}`);
      // showDetailãŒå†åº¦å‘¼ã°ã‚Œã‚‹ã®ã§ã€å±¥æ­´é‡è¤‡ã‚’é˜²ããŸã‚æœ€å¾Œã®è¦ç´ ã‚’å‰Šé™¤
      navigationHistory.pop();
    } else {
      // å±¥æ­´ãŒãªã„å ´åˆã¯ä¸€è¦§ã«æˆ»ã‚‹
      go('#list');
    }
  }
  function addBug() {
   if (!currentUser) {
     alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
     return;
   }
   const status = document.getElementById('new-status').value;
   const title = document.getElementById('new-title').value.trim();
   const description = document.getElementById('new-desc').value.trim();
   const assignee = document.getElementById('new-assignee').value.trim();
   const severity = document.getElementById('new-severity').value;
   const priority = document.getElementById('new-priority').value;
   if (!status) {
     alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
     return;
   }
   if (!title) {
     alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
     return;
   }
   if (!description) {
     alert('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
     return;
   }
   if (!assignee) {
     alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
     return;
   }
   if (!severity) {
     alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
     return;
   }
   if (!priority) {
     alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
     return;
   }
  
   // â˜…ä¿®æ­£: æ–°è¦ä½œæˆãªã®ã§ selectedRelated ã‚’ãã®ã¾ã¾ä½¿ã†
   const selectedRelated = getSelectedRelatedTickets('new-related-container');
   const relatedId = selectedRelated.join(',');
  
   const b = {
     id: 'b_' + Math.random().toString(36).slice(2, 9) + '_' + Date.now(),
     bugNo: 0,
     status: status,
     title: title,
     description: description,
     reproducibility: document.getElementById('new-repro').value,
     reporter: currentUser.userId,
     reporterName: currentUser.userName,
     assignee: assignee,
     severity: severity,
     priority: priority,
     environment: document.getElementById('new-env').value,
     version: document.getElementById('new-version').value,
     relatedTicket: relatedId,
     cause: '',
     fixPlan: '',
     impact: '',
     note: '',
     comments: [],
     history: [{ 
       type: 'create', 
       at: new Date().toISOString(), 
       user: currentUser.userName,
       data: {} 
     }],
     createdAt: new Date().toISOString()
   };
   showLoading();
   callGAS('saveBug', { bug: b, userId: currentUser.userId })
     .then(r => {
       hideLoading();
       if (!r.success) {
         alert(r.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
         return;
       }
       alert('ç™»éŒ²ã—ã¾ã—ãŸ');
       loadBugsFromServer();
     })
     .catch(e => {
       hideLoading();
       alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
     });
 }
  function showDetail(id, fromHistory) {
   const b = bugsCache.find(x => x.id === id);
   currentDetailId = id;
   isEditMode = false;
   const area = document.getElementById('detail-content');
   if (!b) {
     area.innerHTML = '<p>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
     return;
   }
   
   // â˜…ç·¨é›†å‰ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
   originalBugData[id] = JSON.parse(JSON.stringify(b));
   
   // å±¥æ­´ç®¡ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥ãŸå ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
   if (!fromHistory) {
     navigationHistory.push(id);
   }
   
   b.comments = b.comments || [];
   b.history = b.history || [];
   renderDetailContent(b, false);
   renderHistory(b);
   renderComments(b);
   const commentInput = document.getElementById('comment-input');
   if (commentInput) commentInput.value = '';
 }
  function renderDetailContent(b, editMode) {
   const area = document.getElementById('detail-content');
   const canEdit = canEditBug(b);
   const canEditDev = canEditDevFields();
   if (editMode && !canEdit) {
     editMode = false;
   }
   const disabled = editMode ? '' : 'disabled';
   const readonlyStyle = editMode ? '' : 'background:#0f1724;cursor:not-allowed;';
   const devDisabled = (editMode && canEditDev) ? '' : 'disabled';
   const devReadonlyStyle = (editMode && canEditDev) ? '' : 'background:#0f1724;cursor:not-allowed;';
  
   let relatedHtml = '';
   if (editMode) {
     relatedHtml = '<div id="detail-related-container"></div>';
   } else {
     if (b.relatedTicket) {
       const relatedIds = b.relatedTicket.split(',').filter(x => x);
       if (relatedIds.length > 0) {
         relatedHtml = '<div style="margin-top:4px;">';
         relatedIds.forEach(relId => {
           const relatedBug = bugsCache.find(x => x.id === relId);
           if (relatedBug) {
             relatedHtml += `<div><a href="javascript:void(0)" onclick="goToRelatedBug('${relatedBug.id}')" class="bug-link">No.${relatedBug.bugNo} - ${escapeHtml(relatedBug.title)}</a></div>`;
           }
         });
         relatedHtml += '</div>';
       } else {
         relatedHtml = '<div style="margin-top:4px;">ãªã—</div>';
       }
     } else {
       relatedHtml = '<div style="margin-top:4px;">ãªã—</div>';
     }
   }
  
   area.innerHTML = `
     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
       <h2 style="margin:0;">ãƒã‚°è©³ç´° (No.${b.bugNo || '-'})</h2>
       <div style="display:flex; gap:8px;">
         ${canEdit ? 
           (editMode ? 
             `<button class="btn" onclick="saveDetail('${b.id}')">ä¿å­˜</button>
              <button class="btn" onclick="cancelEdit('${b.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>` :
             `<button class="btn" onclick="toggleEditMode('${b.id}')">ç·¨é›†</button>
              <button class="btn" onclick="goBackToPrevious()">æˆ»ã‚‹</button>`
           ) :
           `<button class="btn" onclick="goBackToPrevious()">æˆ»ã‚‹</button>`
         }
       </div>
     </div>
     <label class="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
     <select id="detail-status" style="width:260px;${readonlyStyle}" ${disabled}>
       <option ${b.status === 'OPEN(æ–°è¦)' ? 'selected' : ''}>OPEN(æ–°è¦)</option>
       <option ${b.status === 'ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)' ? 'selected' : ''}>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
       <option ${b.status === 'RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)' ? 'selected' : ''}>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
       <option ${b.status === 'FIXED(ä¿®æ­£æ¸ˆã¿)' ? 'selected' : ''}>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
       <option ${b.status === 'CLOSED(è§£æ¶ˆ)' ? 'selected' : ''}>CLOSED(è§£æ¶ˆ)</option>
       <option ${b.status === 'INVALID(ä¸å…·åˆã§ã¯ãªã„)' ? 'selected' : ''}>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
       <option ${b.status === 'WONTFIX(ä»•æ§˜æ‰±ã„)' ? 'selected' : ''}>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
       <option ${b.status === 'DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)' ? 'selected' : ''}>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
       <option ${b.status === 'WORKSFORME(å†ç¾ã—ãªã„)' ? 'selected' : ''}>WORKSFORME(å†ç¾ã—ãªã„)</option>
       <option ${b.status === 'LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)' ? 'selected' : ''}>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
       <option ${b.status === 'REMIND(åˆ¶é™äº‹é …æ‰±ã„)' ? 'selected' : ''}>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
       <option ${b.status === 'REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)' ? 'selected' : ''}>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
     </select>
     <label class="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
     <input id="detail-title" value="${escapeHtml(b.title || '')}" ${disabled} style="${readonlyStyle}" />
     <label class="required">èª¬æ˜</label>
     <textarea id="detail-desc" rows="6" ${disabled} style="${readonlyStyle}">${escapeHtml(b.description || '')}</textarea>
     <label>å†ç¾æ€§</label>
     <input id="detail-repro" value="${escapeHtml(b.reproducibility || '')}" ${disabled} style="${readonlyStyle}" />
     <label>èµ·ç¥¨è€…</label>
     <input id="detail-reporter" value="${escapeHtml(b.reporterName || b.reporter || '')}" readonly style="background:#0f1724;cursor:not-allowed;" />
     <label class="required">æ‹…å½“è€…</label>
     <input id="detail-assignee" value="${escapeHtml(b.assignee || '')}" ${disabled} style="${readonlyStyle}" />
     <label class="required">é‡è¦åº¦</label>
     <select id="detail-severity" style="width:200px;${readonlyStyle}" ${disabled}>
       <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
       <option value="S(è‡´å‘½çš„)" ${b.severity === 'S(è‡´å‘½çš„)' ? 'selected' : ''}>S(è‡´å‘½çš„)</option>
       <option value="A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)" ${b.severity === 'A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)' ? 'selected' : ''}>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
       <option value="B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)" ${b.severity === 'B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)' ? 'selected' : ''}>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
       <option value="C(å•†å“æ€§ä¸Šå•é¡Œ)" ${b.severity === 'C(å•†å“æ€§ä¸Šå•é¡Œ)' ? 'selected' : ''}>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
       <option value="D(è»½å¾®)" ${b.severity === 'D(è»½å¾®)' ? 'selected' : ''}>D(è»½å¾®)</option>
     </select>
     <label class="required">å„ªå…ˆåº¦</label>
     <select id="detail-priority" style="width:120px;${readonlyStyle}" ${disabled}>
       <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
       <option value="High" ${b.priority === 'High' ? 'selected' : ''}>High</option>
       <option value="Medium" ${b.priority === 'Medium' ? 'selected' : ''}>Medium</option>
       <option value="Low" ${b.priority === 'Low' ? 'selected' : ''}>Low</option>
     </select>
     <label>ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
     <input id="detail-env" value="${escapeHtml(b.environment || '')}" ${disabled} style="${readonlyStyle}" />
     <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
     <input id="detail-version" value="${escapeHtml(b.version || '')}" ${disabled} style="${readonlyStyle}" />
     <label>é–¢é€£ãƒã‚±ãƒƒãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
     ${relatedHtml}
     <label>ä¸å…·åˆåŸå› ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
     <textarea id="detail-cause" rows="4" ${devDisabled} style="${devReadonlyStyle}">${escapeHtml(b.cause || '')}</textarea>
     <label>ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
     <textarea id="detail-fixplan" rows="4" ${devDisabled} style="${devReadonlyStyle}">${escapeHtml(b.fixPlan || '')}</textarea>
     <label>å½±éŸ¿ç¯„å›²ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
     <textarea id="detail-impact" rows="4" ${devDisabled} style="${devReadonlyStyle}">${escapeHtml(b.impact || '')}</textarea>
     <label>å‚™è€ƒï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
     <textarea id="detail-note" rows="4" ${devDisabled} style="${devReadonlyStyle}">${escapeHtml(b.note || '')}</textarea>
   `;
  
   // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é–¢é€£ãƒã‚±ãƒƒãƒˆé¸æŠUIã‚’è¡¨ç¤º
   if (editMode) {
     const relatedIds = (b.relatedTicket || '').split(',').filter(x => x);
     populateRelatedTickets('detail-related-container', b.id, relatedIds);
   }
 }
  function toggleEditMode(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;
    if (!canEditBug(b)) {
      alert('ã“ã®ãƒã‚°ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    isEditMode = true;
    renderDetailContent(b, true);
    renderHistory(b);
  }
  function cancelEdit(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;
    isEditMode = false;
    renderDetailContent(b, false);
    renderHistory(b);
  }
  function saveDetail(id) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }
    const b = bugsCache.find(x => x.id === id);
    if (!b) {
      alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    if (!canEditBug(b)) {
      alert('ã“ã®ãƒã‚°ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    const v = (id) => {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    };
    const status = v('detail-status');
    const title = v('detail-title');
    const description = v('detail-desc');
    const assignee = v('detail-assignee');
    const severity = v('detail-severity');
    const priority = v('detail-priority');
    if (!status) {
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!title) {
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!description) {
      alert('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!assignee) {
      alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!severity) {
      alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!priority) {
      alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    // â˜…ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ before ã‚’å–å¾—
    const before = originalBugData[id] ? JSON.parse(JSON.stringify(originalBugData[id])) : JSON.parse(JSON.stringify(b));
    
    b.status = status;
    b.title = title;
    b.description = description;
    b.reproducibility = v('detail-repro');
    b.assignee = assignee;
    b.severity = severity;
    b.priority = priority;
    b.environment = v('detail-env');
    b.version = v('detail-version');
  
    const selectedRelated = getSelectedRelatedTickets('detail-related-container');
    
    // â˜…ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ—¢å­˜ã®é–¢é€£ãƒã‚±ãƒƒãƒˆã‚’å–å¾—
    const existingRelatedIds = (before.relatedTicket || '').split(',').filter(x => x);
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ãˆãªã„ãƒã‚±ãƒƒãƒˆIDã‚’æŠ½å‡ºï¼ˆä¿æŒã™ã¹ããƒã‚±ãƒƒãƒˆï¼‰
    const invisibleTickets = existingRelatedIds.filter(relId => {
      return !bugsCache.some(bug => bug.id === relId);
    });
    
    // æ–°ã—ãé¸æŠã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆã¨ã€è¦‹ãˆãªã„ãƒã‚±ãƒƒãƒˆã‚’ãƒãƒ¼ã‚¸
    const allRelatedTickets = [...new Set([...selectedRelated, ...invisibleTickets])];
    b.relatedTicket = allRelatedTickets.join(',');
    
    if (canEditDevFields()) {
      b.cause = v('detail-cause');
      b.fixPlan = v('detail-fixplan');
      b.impact = v('detail-impact');
      b.note = v('detail-note');
    }
    const changes = [];
    const FIELD_LABELS = {
      status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      title: 'ã‚¿ã‚¤ãƒˆãƒ«',
      description: 'èª¬æ˜',
      reproducibility: 'å†ç¾æ€§',
      severity: 'é‡è¦åº¦',
      priority: 'å„ªå…ˆåº¦',
      assignee: 'æ‹…å½“è€…',
      environment: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
      version: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
      relatedTicket: 'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
      cause: 'ä¸å…·åˆåŸå› ',
      fixPlan: 'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
      impact: 'å½±éŸ¿ç¯„å›²',
      note: 'å‚™è€ƒ'
    };
    Object.keys(FIELD_LABELS).forEach(k => {
      if (typeof b[k] === 'string' && before[k] !== b[k]) {
        let fromValue = before[k] || '';
        let toValue = b[k] || '';
      
        // é–¢é€£ãƒã‚±ãƒƒãƒˆã®å ´åˆã€IDã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«å¤‰æ›
        if (k === 'relatedTicket') {
          fromValue = convertRelatedIdsToTitles(fromValue);
          toValue = convertRelatedIdsToTitles(toValue);
        }
        
        changes.push({
          field: k,
          from: fromValue,
          to: toValue
        });
      }
    });
    if (changes.length) {
      b.history = b.history || [];
      b.history.push({
        type: 'edit',
        at: new Date().toISOString(),
        changes: changes,
        user: currentUser.userName
      });
    }
    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        isEditMode = false;
        const index = bugsCache.findIndex(x => x.id === id);
        if (index !== -1) {
          bugsCache[index] = b;
        }
        renderDetailContent(b, false);
        renderHistory(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }
  function convertRelatedIdsToTitles(idsString) {
    if (!idsString) return '(ãªã—)';
    const ids = idsString.split(',').filter(x => x);
    if (ids.length === 0) return '(ãªã—)';
    const titles = ids.map(id => {
      const bug = bugsCache.find(x => x.id === id);
      return bug ? `No.${bug.bugNo} - ${bug.title}` : id;
    });
    return titles.join(', ');
  }
  function renderHistory(b) {
    const box = document.getElementById('detail-history');
    if (!box) return;
    box.innerHTML = '';
    if (!b.history || b.history.length === 0) {
      box.textContent = 'å¤‰æ›´å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
      return;
    }
    const FIELD_LABELS = {
      status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      title: 'ã‚¿ã‚¤ãƒˆãƒ«',
      description: 'èª¬æ˜',
      reproducibility: 'å†ç¾æ€§',
      severity: 'é‡è¦åº¦',
      priority: 'å„ªå…ˆåº¦',
      reporter: 'èµ·ç¥¨è€…',
      assignee: 'æ‹…å½“è€…',
      environment: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
      version: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
      relatedTicket: 'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
      cause: 'ä¸å…·åˆåŸå› ',
      fixPlan: 'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
      impact: 'å½±éŸ¿ç¯„å›²',
      note: 'å‚™è€ƒ'
    };
    b.history.slice().reverse().forEach(h => {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '8px';
      const time = document.createElement('div');
      time.style.fontSize = '12px';
      time.style.color = '#9aa4b2';
      time.textContent = new Date(h.at).toLocaleString() + (h.user ? ' - ' + h.user : '');
      const body = document.createElement('div');
      if (h.type === 'create') {
        body.textContent = 'æ–°è¦ä½œæˆ';
      }
      if (h.type === 'edit' && Array.isArray(h.changes)) {
        const ul = document.createElement('ul');
        ul.style.marginLeft = '20px';
        h.changes.forEach(c => {
          const li = document.createElement('li');
          if (typeof c === 'string') {
            const key = c.split(':')[0];
            const label = FIELD_LABELS[key] || key;
            li.textContent = c.replace(key, label);
          } else {
            const label = FIELD_LABELS[c.field] || c.field;
            li.textContent = `${label}ï¼š${c.from || '(ç©º)'} â†’ ${c.to || '(ç©º)'}`;
          }
          ul.appendChild(li);
        });
        body.appendChild(document.createTextNode('ç·¨é›†'));
        body.appendChild(ul);
      }
      wrap.appendChild(time);
      wrap.appendChild(body);
      box.appendChild(wrap);
    });
  }
  function renderComments(b) {
    const list = document.getElementById('comment-list');
    const collapsed = document.getElementById('comment-collapsed');
    if (!list || !collapsed) return;
    const cs = (b.comments || []).slice().sort((a, c) => new Date(c.createdAt) - new Date(a.createdAt));
    if (!cs.length) {
      collapsed.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
      collapsed.style.display = 'block';
      list.style.display = 'none';
      return;
    }
    collapsed.textContent = cs[0].text;
    collapsed.style.display = commentsExpanded[b.id] ? 'none' : 'block';
    list.innerHTML = '';
    list.style.display = commentsExpanded[b.id] ? 'block' : 'none';
    cs.forEach(c => {
      const d = document.createElement('div');
      d.className = 'comment-item';
      d.innerHTML = `
        <div style="flex:1;">
          <div class="comment-text">${escapeHtml(c.text)}</div>
          <div class="comment-meta">${new Date(c.createdAt).toLocaleString()}${c.userName ? ' - ' + c.userName : ''}</div>
        </div>
        <button class="btn" onclick="deleteComment('${b.id}','${c.id}')">å‰Šé™¤</button>`;
      list.appendChild(d);
    });
  }
  function toggleComments(id) {
    commentsExpanded[id] = !commentsExpanded[id];
    const b = bugsCache.find(x => x.id === id);
    if (b) renderComments(b);
  }
  function addComment(id) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }
    const ta = document.getElementById('comment-input');
    if (!ta) return;
    const t = ta.value.trim();
    if (!t) {
      alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;
    b.comments = b.comments || [];
    b.comments.push({
      id: 'c_' + Math.random().toString(36).slice(2, 9),
      text: t,
      userName: currentUser.userName,
      createdAt: new Date().toISOString()
    });
    ta.value = '';
    commentsExpanded[id] = true;
    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ã‚³ãƒ¡ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        renderComments(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }
  function deleteComment(bugId, cid) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }
    if (!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    const b = bugsCache.find(x => x.id === bugId);
    if (!b) return;
    b.comments = b.comments.filter(c => c.id !== cid);
    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        renderComments(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }
</script>
</body>
</html>

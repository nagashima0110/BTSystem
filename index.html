<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸª·L.O.T.U.S</title>
  <style>
    body { background:#0f1724; color:#fff; font-family:sans-serif; margin:0; padding:20px; }
    section { display:none; }
    .active { display:block; }
    input, textarea, select {
      background:#1d2738; border:1px solid #2c3a52; color:#fff; padding:8px;
      border-radius:8px; margin-bottom:12px; box-sizing:border-box;
    }
    select option { color:#000; background:#fff; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’æ˜ã‚‹ãã™ã‚‹ */
    .login-box input {
      background:#3a4a5f;
      border:1px solid #4a5a6f;
    }

    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:16px; table-layout:fixed; }

    th, td {
      border-bottom:1px solid #2a3548; padding:12px 8px; vertical-align:middle;
      color:#e2e8f0; overflow:hidden; text-overflow:ellipsis;
    }

    th:nth-child(1), td:nth-child(1) { width:48px; }
    th:nth-child(2), td:nth-child(2) {
      width:600px;
      white-space:normal;
      word-break:break-word;
    }
    th:nth-child(3), td:nth-child(3) { width:110px; }
    th:nth-child(4), td:nth-child(4) { width:110px; }
    th:nth-child(5), td:nth-child(5) { width:110px; text-align:center; }
    th:nth-child(6), td:nth-child(6) { width:90px; }

    tr:hover { background:#1a2536; }
    .btn { padding:8px 12px; background:#1e90ff; color:#fff; border:none; border-radius:6px; cursor:pointer; }

    input, textarea { width: 70%; max-width: 800px; }
    #new input, #new textarea, #new select { display:block; width:70%; margin-bottom:12px; }
    select.short-select { width:auto; min-width:120px; max-width:200px; display:inline-block; }
    #new label { display:block; margin-top:8px; margin-bottom:4px; }
    .empty-row td { text-align:center; color:#9aa4b2; white-space:normal; }

    .detail-wrap { display:flex; gap:20px; align-items:flex-start; }
    #detail-main { flex:1; }
    #comment-side { width:340px; background:transparent; }
    #comment-side .card { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }

    #detail-content label{display:block;margin-top:10px;font-weight:bold;}
    #detail-content input,#detail-content textarea,#detail-content select{ width:100%; box-sizing:border-box; margin-top:4px; }

    .comment-list { margin-top:8px; }
    .comment-item { padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; }
    .comment-text{ white-space:pre-wrap; color:#e6eef6; }
    .comment-meta{ font-size:12px; color:#9aa4b2; }

    .collapsed-latest { font-style:italic; color:#cbd5e1; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« - ä¸­å¤®é…ç½®ã«ä¿®æ­£ */
    #login {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      padding:20px;
    }
    .login-box {
      background:#1d2738;
      padding:32px;
      border-radius:12px;
      border:1px solid #2c3a52;
      width:100%;
      max-width:400px;
    }
    .login-box h2 {
      margin-top:0;
      text-align:center;
    }
    .login-box input {
      width:100%;
      margin-bottom:16px;
    }
    .login-box .btn {
      width:100%;
    }
    .error-msg {
      color:#ff6b6b;
      font-size:14px;
      margin-top:8px;
      text-align:center;
    }
    #loading {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(15,23,36,0.9);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #loading.show {
      display:flex;
    }
    .spinner {
      border:4px solid #2c3a52;
      border-top:4px solid #1e90ff;
      border-radius:50%;
      width:50px;
      height:50px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    /* å¿…é ˆé …ç›®ã®ãƒ©ãƒ™ãƒ«è¡¨ç¤º */
    .required::after {
      content: ' *';
      color: #ff6b6b;
      font-weight: bold;
    }

    @media (max-width:900px){ .detail-wrap{ flex-direction:column;} #comment-side{ width:100%; } }
  </style>
</head>
<body>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <section id="login">
    <div class="login-box">
      <h2>ğŸª·L.O.T.U.S</h2>
      <h4>Bug Tracking System</h4>
      <p><font size="1"><i><B>L</B>ogical <B>O</B>rganization of <B>T</B>asks and <B>U</B>nresolved <B>S</B>ituations</i></font></p>
      <input id="login-userId" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" />
      <input id="login-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
      <button class="btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error-msg"></div>
    </div>
  </section>

  <nav id="main-nav" style="display:none;margin-bottom:12px;">
    <button class="btn" id="nav-list" onclick="go('#list')" style="display:none;">ä¸€è¦§</button>
    <button class="btn" id="nav-new" onclick="go('#new')">æ–°è¦ç™»éŒ²</button>
    <button class="btn" onclick="doLogout()" style="margin-left:auto;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span id="user-info" style="line-height:32px;margin-left:8px;color:#9aa4b2;"></span>
  </nav>

  <!-- ä¸€è¦§ç”»é¢ -->
  <section id="list">
    <h2>ãƒã‚°ä¸€è¦§</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <input id="search" type="text" placeholder="æ¤œç´¢ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ãƒ©ãƒ™ãƒ«)" style="flex:1;min-width:220px;" onkeyup="renderList()" />
    </div>

    <div class="table-wrap">
      <table id="bugTable">
        <thead>
          <tr>
            <th>No.</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>é‡è¦åº¦</th>
            <th>å„ªå…ˆåº¦</th>
            <th>ãƒ©ãƒ™ãƒ«</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- æ–°è¦ç™»éŒ²ç”»é¢ - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é †åºå¤‰æ›´ -->
  <section id="new">
    <h2>æ–°ã—ã„ãƒã‚°ã‚’ç™»éŒ²</h2>

    <label for="new-title" class="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input id="new-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" required />

    <label for="new-desc">èª¬æ˜</label>
    <textarea id="new-desc" placeholder="ä¸å…·åˆã®å†ç¾æ‰‹é †ç­‰ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" rows="6"></textarea>

    <label for="new-status" class="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select id="new-status" class="short-select" required>
      <option selected>OPEN(æ–°è¦)</option>
      <option>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
      <option>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
      <option>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
      <option>CLOSED(è§£æ¶ˆ)</option>
      <option>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
      <option>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
      <option>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
      <option>WORKSFORME(å†ç¾ã—ãªã„)</option>
      <option>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
      <option>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
      <option>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
    </select>

    <label for="new-labels">ãƒ©ãƒ™ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input id="new-labels" placeholder="ãƒ©ãƒ™ãƒ« (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)" />

    <label>èµ·ç¥¨è€…</label>
    <input id="new-reporter" readonly style="background:#0f1724;cursor:not-allowed;" />

    <label for="new-assignee" class="required">æ‹…å½“è€…</label>
    <input id="new-assignee" placeholder="æ‹…å½“è€…" required />

    <label for="new-severity" class="required">é‡è¦åº¦</label>
    <select id="new-severity" class="short-select" required>
      <option>S(è‡´å‘½çš„)</option>
      <option>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
      <option>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
      <option>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
      <option>D(è»½å¾®)</option>
    </select>

    <label for="new-priority" class="required">å„ªå…ˆåº¦</label>
    <select id="new-priority" class="short-select" required>
      <option selected>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>

    <label for="new-repro">å†ç¾æ€§</label>
    <input id="new-repro" placeholder="å†ç¾æ€§" />

    <label for="new-env">ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
    <input id="new-env" placeholder="ãƒ†ã‚¹ãƒˆç’°å¢ƒ" />

    <label for="new-version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
    <input id="new-version" placeholder="ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±" />

    <label for="new-related">é–¢é€£ãƒã‚±ãƒƒãƒˆ</label>
    <input id="new-related" placeholder="é–¢é€£ãƒã‚±ãƒƒãƒˆ" />

    <div style="margin-top:8px;display:flex;gap:8px;">
      <button class="btn" onclick="addBug()">ç™»éŒ²</button>
      <button class="btn" onclick="go('#list')" style="background:#6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </section>

  <!-- è©³ç´°ç”»é¢ -->
  <section id="detail">
    <div class="detail-wrap">
      <div id="detail-main">
        <div id="detail-content"></div>
      </div>

      <aside id="comment-side">
        <div class="card">
          <h3 style="margin-top:0;margin-bottom:8px;">é–‹ç™ºè€…ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="comment-controls" style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
            <button class="btn" id="toggle-comments-btn" onclick="toggleComments(currentDetailId)">å±•é–‹/æŠ˜ç•³</button>
            <div style="flex:1;text-align:right;color:#9aa4b2;font-size:12px;">æ–°ã—ã„é †</div>
          </div>

          <div id="comment-collapsed" class="collapsed-latest" style="display:none;padding:8px;">ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>

          <div id="comment-list" class="comment-list" style="display:none;max-height:360px;overflow:auto;"></div>

          <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:8px;">
            <textarea id="comment-input" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" onclick="addComment(currentDetailId)">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>

<script>
  //============================
  // è¨­å®š
  //============================
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz9TRSMq6mxAiBWZRaNtOSm_jUNrqCddyJPqVegy_8-FVNPk-8bROvxI3gcq7dicO6y/exec';

  function callGAS(action, payload) {
    console.log('callGAS - action:', action, 'payload:', payload);
    return fetch(GAS_ENDPOINT, {
      method: 'POST',
      body: JSON.stringify({ action, payload })
    })
    .then(r => {
      console.log('Response status:', r.status);
      return r.json();
    })
    .then(data => {
      console.log('Response data:', data);
      return data;
    })
    .catch(error => {
      console.error('callGAS error:', error);
      throw error;
    });
  }

  //============================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  //============================
  let currentUser = null;
  let bugsCache = [];
  let currentDetailId = null;
  let commentsExpanded = {};
  let isEditMode = false;

  //============================
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  //============================
  function showLoading() {
    document.getElementById('loading').classList.add('show');
  }
  function hideLoading() {
    document.getElementById('loading').classList.remove('show');
  }

  //============================
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  //============================
  function doLogin() {
    const userId = document.getElementById('login-userId').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const errorEl = document.getElementById('login-error');

    console.log('Attempting login with userId:', userId);

    if (!userId || !password) {
      errorEl.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      return;
    }

    showLoading();
    errorEl.textContent = '';

    callGAS('authenticate', { userId, password })
      .then(result => {
        hideLoading();
        console.log('Login result:', result);
        
        if (!result.success) {
          errorEl.textContent = result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }

        currentUser = {
          userId: result.userId,
          userName: result.userName,
          userType: result.userType
        };

        console.log('Current user set:', currentUser);

        document.getElementById('login').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('user-info').textContent =
          `${result.userName} (${result.userType === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬'})`;

        loadBugsFromServer();
      })
      .catch(e => {
        hideLoading();
        console.error('Login error:', e);
        errorEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
      });
  }

  //============================
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  //============================
  function doLogout() {
    currentUser = null;
    bugsCache = [];
    location.hash = '';
    location.reload();
  }

  //============================
  // ãƒã‚°ä¸€è¦§å–å¾—
  //============================
  function loadBugsFromServer() {
    if (!currentUser) {
      console.error('loadBugsFromServer: currentUser is null');
      return;
    }

    console.log('loadBugsFromServer called with:', currentUser);

    showLoading();
    callGAS('getBugs', {
      userId: currentUser.userId,
      userType: currentUser.userType
    })
      .then(result => {
        hideLoading();
        console.log('getBugs result:', result);
        
        if (!result.success) {
          alert(result.message || 'èª­ã¿è¾¼ã¿å¤±æ•—');
          return;
        }
        
        bugsCache = result.bugs || [];
        console.log('bugsCache updated:', bugsCache.length, 'bugs');
        console.log('Bug IDs:', bugsCache.map(b => b.id));
        console.log('Bug reporters:', bugsCache.map(b => ({ id: b.id, reporter: b.reporter, reporterName: b.reporterName })));
        
        go('#list');
        // ç”»é¢é·ç§»å¾Œã«ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
          window.scrollTo(0, 0);
          renderList();
        }, 100);
      })
      .catch(e => {
        hideLoading();
        console.error('loadBugsFromServer error:', e);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
      });
  }

  //============================
  // ç”»é¢é·ç§»
  //============================
  function go(hash) { 
    location.hash = hash;
    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    window.scrollTo(0, 0);
  }

  function clearNewForm() {
    const ids = ['new-title', 'new-desc', 'new-labels', 'new-env', 'new-version', 'new-repro', 'new-related', 'new-assignee'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    // èµ·ç¥¨è€…ã‚’ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«è¨­å®š
    const reporterEl = document.getElementById('new-reporter');
    if (reporterEl && currentUser) {
      reporterEl.value = currentUser.userName;
    }

    const status = document.getElementById('new-status');
    if (status) status.value = 'OPEN(æ–°è¦)';

    const priority = document.getElementById('new-priority');
    if (priority) priority.value = 'High';

    const severity = document.getElementById('new-severity');
    if (severity) severity.selectedIndex = 0;
  }

  function route() {
    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    window.scrollTo(0, 0);
    
    if (!window.__booted) {
      window.__booted = true;
      document.getElementById('login').style.display = 'flex';
      document.getElementById('login').classList.add('active');
      return;
    }

    const hash = location.hash || '#list';
    const clean = hash.split('/')[0];

    if (!currentUser && clean !== '#login') {
      location.hash = '';
      return;
    }

    document.querySelectorAll('section').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });

    const pg = document.querySelector(clean);
    if (pg) {
      pg.classList.add('active');
      pg.style.display = 'block';
    }

    const navNew = document.getElementById('nav-new');
    if (navNew) {
      navNew.style.display = (clean === '#new' || clean === '#detail') ? 'none' : 'inline-block';
    }

    if (clean === '#new') {
      clearNewForm();
    }
    if (clean === '#list') {
      console.log('Routing to list, bugs:', bugsCache.length); // ãƒ‡ãƒãƒƒã‚°ç”¨
      renderList();
    }
    if (clean === '#detail' && hash.includes('/')) {
      const bugId = hash.split('/')[1];
      console.log('Routing to detail:', bugId); // ãƒ‡ãƒãƒƒã‚°ç”¨
      showDetail(bugId);
    }
  }

  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  //============================
  // ä¸€è¦§è¡¨ç¤ºï¼ˆæ¤œç´¢æ©Ÿèƒ½ä¿®æ­£ï¼‰
  //============================
  function renderList() {
    console.log('renderList called, bugsCache:', bugsCache); // ãƒ‡ãƒãƒƒã‚°ç”¨
    const searchInput = document.getElementById('search');
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    console.log('Search query:', search); // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    const tbody = document.querySelector('#bugTable tbody');
    
    if (!tbody) {
      console.error('tbody not found');
      return;
    }
    
    tbody.innerHTML = '';

    const sorted = bugsCache.slice().sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    const filtered = sorted.filter(b => {
      if (!search) return true; // æ¤œç´¢èªãŒãªã„å ´åˆã¯å…¨ã¦è¡¨ç¤º
      
      const searchFields = [
        b.title || '',
        b.description || '',
        b.status || '',
        b.severity || '',
        b.priority || '',
        b.assignee || '',
        b.reporterName || '',
        (b.labels || []).join(' ')
      ].join(' ').toLowerCase();
      
      return searchFields.includes(search);
    });

    console.log('Filtered bugs:', filtered.length, 'out of', sorted.length); // ãƒ‡ãƒãƒƒã‚°ç”¨

    if (filtered.length === 0) {
      const tr = document.createElement('tr');
      tr.className = 'empty-row';
      tr.innerHTML = '<td colspan="6">è¡¨ç¤ºã™ã‚‹é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</td>';
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach((b, idx) => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(b.title || '')}</td>
        <td>${escapeHtml(b.status || '')}</td>
        <td>${escapeHtml(b.severity || '')}</td>
        <td>${escapeHtml(b.priority || '')}</td>
        <td>${escapeHtml((b.labels || []).join(', '))}</td>`;
      tr.addEventListener('click', () => { 
        console.log('Clicked bug:', b.id); // ãƒ‡ãƒãƒƒã‚°ç”¨
        go(`#detail/${b.id}`); 
      });
      tbody.appendChild(tr);
    });
  }

  //============================
  // è©³ç´°ä¿å­˜ï¼ˆå¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼‰
  //============================
  function saveDetail(id) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }

    const b = bugsCache.find(x => x.id === id);
    if (!b) {
      alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const v = (id) => {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    };

    // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    const title = v('detail-title');
    const status = v('detail-status');
    const assignee = v('detail-assignee');
    const severity = v('detail-severity');
    const priority = v('detail-priority');

    if (!title) {
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!status) {
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!assignee) {
      alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!severity) {
      alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!priority) {
      alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const before = JSON.parse(JSON.stringify(b));

    b.title = title;
    b.description = v('detail-desc');
    b.status = status;
    b.severity = severity;
    b.priority = priority;
    b.labels = v('detail-labels').split(',').map(x => x.trim()).filter(x => x);
    b.assignee = assignee;
    b.reproducibility = v('detail-repro');
    b.environment = v('detail-env');
    b.version = v('detail-version');
    b.related = v('detail-related');
    b.cause = v('detail-cause');
    b.fixPlan = v('detail-fixplan');
    b.impact = v('detail-impact');
    b.note = v('detail-note');

    // å¤‰æ›´å±¥æ­´ã‚’è¨˜éŒ²
    const changes = [];
    const FIELD_LABELS = {
      title: 'ã‚¿ã‚¤ãƒˆãƒ«',
      description: 'èª¬æ˜',
      status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      severity: 'é‡è¦åº¦',
      priority: 'å„ªå…ˆåº¦',
      assignee: 'æ‹…å½“è€…',
      reproducibility: 'å†ç¾æ€§',
      environment: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
      version: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
      related: 'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
      cause: 'ä¸å…·åˆåŸå› ',
      fixPlan: 'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
      impact: 'å½±éŸ¿ç¯„å›²',
      note: 'å‚™è€ƒ'
    };

    Object.keys(FIELD_LABELS).forEach(k => {
      if (typeof b[k] === 'string' && before[k] !== b[k]) {
        changes.push({
          field: k,
          from: before[k] || '',
          to: b[k] || ''
        });
      }
    });

    if (changes.length) {
      b.history = b.history || [];
      b.history.push({
        type: 'edit',
        at: new Date().toISOString(),
        changes: changes,
        user: currentUser.userName
      });
    }

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        isEditMode = false;
        
        // bugsCacheå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const index = bugsCache.findIndex(x => x.id === id);
        if (index !== -1) {
          bugsCache[index] = b;
        }
        
        // è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§å†æç”»
        renderDetailContent(b, false);
        renderHistory(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }

  //============================
  // å¤‰æ›´å±¥æ­´è¡¨ç¤º
  //============================
  function renderHistory(b) {
    const box = document.getElementById('detail-history');
    if (!box) return;

    box.innerHTML = '';

    if (!b.history || b.history.length === 0) {
      box.textContent = 'å¤‰æ›´å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
      return;
    }

    const FIELD_LABELS = {
      title: 'ã‚¿ã‚¤ãƒˆãƒ«',
      description: 'èª¬æ˜',
      status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
      severity: 'é‡è¦åº¦',
      priority: 'å„ªå…ˆåº¦',
      reporter: 'èµ·ç¥¨è€…',
      assignee: 'æ‹…å½“è€…',
      labels: 'ãƒ©ãƒ™ãƒ«',
      environment: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
      version: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
      reproducibility: 'å†ç¾æ€§',
      related: 'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
      cause: 'ä¸å…·åˆåŸå› ',
      fixPlan: 'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
      impact: 'å½±éŸ¿ç¯„å›²',
      note: 'å‚™è€ƒ'
    };

    b.history.slice().reverse().forEach(h => {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '8px';

      const time = document.createElement('div');
      time.style.fontSize = '12px';
      time.style.color = '#9aa4b2';
      time.textContent = new Date(h.at).toLocaleString() + (h.user ? ' - ' + h.user : '');

      const body = document.createElement('div');

      if (h.type === 'create') {
        body.textContent = 'æ–°è¦ä½œæˆ';
      }

      if (h.type === 'edit' && Array.isArray(h.changes)) {
        const ul = document.createElement('ul');
        ul.style.marginLeft = '20px';
        h.changes.forEach(c => {
          const li = document.createElement('li');
          if (typeof c === 'string') {
            const key = c.split(':')[0];
            const label = FIELD_LABELS[key] || key;
            li.textContent = c.replace(key, label);
          } else {
            const label = FIELD_LABELS[c.field] || c.field;
            li.textContent = `${label}ï¼š${c.from || '(ç©º)'} â†’ ${c.to || '(ç©º)'}`;
          }
          ul.appendChild(li);
        });
        body.appendChild(document.createTextNode('ç·¨é›†'));
        body.appendChild(ul);
      }

      wrap.appendChild(time);
      wrap.appendChild(body);
      box.appendChild(wrap);
    });
  }

  //============================
  // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
  //============================
  function renderComments(b) {
    const list = document.getElementById('comment-list');
    const collapsed = document.getElementById('comment-collapsed');
    if (!list || !collapsed) return;

    const cs = (b.comments || []).slice().sort((a, c) => new Date(c.createdAt) - new Date(a.createdAt));

    if (!cs.length) {
      collapsed.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
      collapsed.style.display = 'block';
      list.style.display = 'none';
      return;
    }

    collapsed.textContent = cs[0].text;
    collapsed.style.display = commentsExpanded[b.id] ? 'none' : 'block';
    list.innerHTML = '';
    list.style.display = commentsExpanded[b.id] ? 'block' : 'none';

    cs.forEach(c => {
      const d = document.createElement('div');
      d.className = 'comment-item';
      d.innerHTML = `
        <div style="flex:1;">
          <div class="comment-text">${escapeHtml(c.text)}</div>
          <div class="comment-meta">${new Date(c.createdAt).toLocaleString()}${c.userName ? ' - ' + c.userName : ''}</div>
        </div>
        <button class="btn" onclick="deleteComment('${b.id}','${c.id}')">å‰Šé™¤</button>`;
      list.appendChild(d);
    });
  }

  //============================
  // ã‚³ãƒ¡ãƒ³ãƒˆå±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
  //============================
  function toggleComments(id) {
    commentsExpanded[id] = !commentsExpanded[id];
    const b = bugsCache.find(x => x.id === id);
    if (b) renderComments(b);
  }

  //============================
  // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
  //============================
  function addComment(id) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }

    const ta = document.getElementById('comment-input');
    if (!ta) return;

    const t = ta.value.trim();
    if (!t) {
      alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const b = bugsCache.find(x => x.id === id);
    if (!b) return;

    b.comments = b.comments || [];
    b.comments.push({
      id: 'c_' + Math.random().toString(36).slice(2, 9),
      text: t,
      userName: currentUser.userName,
      createdAt: new Date().toISOString()
    });

    ta.value = '';
    commentsExpanded[id] = true;

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ã‚³ãƒ¡ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        renderComments(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }

  //============================
  // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
  //============================
  function deleteComment(bugId, cid) {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }

    if (!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    const b = bugsCache.find(x => x.id === bugId);
    if (!b) return;

    b.comments = b.comments.filter(c => c.id !== cid);

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        renderComments(b);
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }

  //============================
  // è©³ç´°ç”»é¢è¡¨ç¤ºï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œãƒ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é †åºå¤‰æ›´ç‰ˆï¼‰
  //============================
  function showDetail(id) {
    console.log('========== showDetail START ==========');
    console.log('showDetail called with id:', id);
    console.log('bugsCache length:', bugsCache.length);
    console.log('bugsCache contents:', JSON.stringify(bugsCache, null, 2));
    
    const b = bugsCache.find(x => {
      console.log('Comparing:', x.id, '===', id, '?', x.id === id);
      return x.id === id;
    });
    
    console.log('Found bug:', b ? JSON.stringify(b, null, 2) : 'NOT FOUND');
    
    currentDetailId = id;
    isEditMode = false; // åˆå›è¡¨ç¤ºã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
    const area = document.getElementById('detail-content');

    if (!b) {
      const msg = '<p>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>' +
                  '<p>æ¢ã—ã¦ã„ã‚‹ID: ' + escapeHtml(id) + '</p>' +
                  '<p>åˆ©ç”¨å¯èƒ½ãªãƒã‚°æ•°: ' + bugsCache.length + '</p>' +
                  '<p>åˆ©ç”¨å¯èƒ½ãªID: ' + bugsCache.map(x => x.id).join(', ') + '</p>';
      area.innerHTML = msg;
      console.log('Bug not found, showing error message');
      return;
    }

    b.comments = b.comments || [];
    b.history = b.history || [];

    console.log('Rendering detail content...');
    renderDetailContent(b, false);
    renderHistory(b);
    renderComments(b);
    
    // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    const commentInput = document.getElementById('comment-input');
    if (commentInput) commentInput.value = '';
    
    console.log('========== showDetail END ==========');
  }

  //============================
  // è©³ç´°ç”»é¢ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æç”»ï¼ˆé–²è¦§/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å¯¾å¿œï¼‰
  //============================
  function renderDetailContent(b, editMode) {
    const area = document.getElementById('detail-content');
    const disabled = editMode ? '' : 'disabled';
    const readonlyStyle = editMode ? '' : 'background:#0f1724;cursor:not-allowed;';

    area.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; max-width:70%;">
        <h2 style="margin:0;">ãƒã‚°è©³ç´°</h2>
        <div style="display:flex; gap:8px;">
          ${editMode ? 
            `<button class="btn" onclick="saveDetail('${b.id}')">ä¿å­˜</button>
             <button class="btn" onclick="cancelEdit('${b.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>` :
            `<button class="btn" onclick="toggleEditMode('${b.id}')">ç·¨é›†</button>
             <button class="btn" onclick="go('#list')">æˆ»ã‚‹</button>`
          }
        </div>
      </div>

      <label class="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="detail-title" value="${escapeHtml(b.title || '')}" ${disabled} style="${readonlyStyle}" />

      <label>èª¬æ˜</label>
      <textarea id="detail-desc" rows="6" ${disabled} style="${readonlyStyle}">${escapeHtml(b.description || '')}</textarea>

      <label class="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <select id="detail-status" style="width:260px;${readonlyStyle}" ${disabled}>
        <option ${b.status === 'OPEN(æ–°è¦)' ? 'selected' : ''}>OPEN(æ–°è¦)</option>
        <option ${b.status === 'ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)' ? 'selected' : ''}>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
        <option ${b.status === 'RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)' ? 'selected' : ''}>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
        <option ${b.status === 'FIXED(ä¿®æ­£æ¸ˆã¿)' ? 'selected' : ''}>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
        <option ${b.status === 'CLOSED(è§£æ¶ˆ)' ? 'selected' : ''}>CLOSED(è§£æ¶ˆ)</option>
        <option ${b.status === 'INVALID(ä¸å…·åˆã§ã¯ãªã„)' ? 'selected' : ''}>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
        <option ${b.status === 'WONTFIX(ä»•æ§˜æ‰±ã„)' ? 'selected' : ''}>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
        <option ${b.status === 'DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)' ? 'selected' : ''}>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
        <option ${b.status === 'WORKSFORME(å†ç¾ã—ãªã„)' ? 'selected' : ''}>WORKSFORME(å†ç¾ã—ãªã„)</option>
        <option ${b.status === 'LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)' ? 'selected' : ''}>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
        <option ${b.status === 'REMIND(åˆ¶é™äº‹é …æ‰±ã„)' ? 'selected' : ''}>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
        <option ${b.status === 'REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)' ? 'selected' : ''}>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
      </select>

      <label>ãƒ©ãƒ™ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
      <input id="detail-labels" value="${escapeHtml((b.labels || []).join(', '))}" ${disabled} style="${readonlyStyle}" />

      <label>èµ·ç¥¨è€…</label>
      <input id="detail-reporter" value="${escapeHtml(b.reporterName || b.reporter || '')}" readonly style="background:#0f1724;cursor:not-allowed;" />

      <label class="required">æ‹…å½“è€…</label>
      <input id="detail-assignee" value="${escapeHtml(b.assignee || '')}" ${disabled} style="${readonlyStyle}" />

      <label class="required">é‡è¦åº¦</label>
      <select id="detail-severity" style="width:200px;${readonlyStyle}" ${disabled}>
        <option value="S(è‡´å‘½çš„)" ${b.severity === 'S(è‡´å‘½çš„)' ? 'selected' : ''}>S(è‡´å‘½çš„)</option>
        <option value="A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)" ${b.severity === 'A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)' ? 'selected' : ''}>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
        <option value="B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)" ${b.severity === 'B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)' ? 'selected' : ''}>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
        <option value="C(å•†å“æ€§ä¸Šå•é¡Œ)" ${b.severity === 'C(å•†å“æ€§ä¸Šå•é¡Œ)' ? 'selected' : ''}>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
        <option value="D(è»½å¾®)" ${b.severity === 'D(è»½å¾®)' ? 'selected' : ''}>D(è»½å¾®)</option>
      </select>

      <label class="required">å„ªå…ˆåº¦</label>
      <select id="detail-priority" style="width:120px;${readonlyStyle}" ${disabled}>
        <option value="High" ${b.priority === 'High' ? 'selected' : ''}>High</option>
        <option value="Medium" ${b.priority === 'Medium' ? 'selected' : ''}>Medium</option>
        <option value="Low" ${b.priority === 'Low' ? 'selected' : ''}>Low</option>
      </select>

      <label>å†ç¾æ€§</label>
      <input id="detail-repro" value="${escapeHtml(b.reproducibility || '')}" ${disabled} style="${readonlyStyle}" />

      <label>ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
      <input id="detail-env" value="${escapeHtml(b.environment || '')}" ${disabled} style="${readonlyStyle}" />

      <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
      <input id="detail-version" value="${escapeHtml(b.version || '')}" ${disabled} style="${readonlyStyle}" />

      <label>é–¢é€£ãƒã‚±ãƒƒãƒˆ</label>
      <input id="detail-related" value="${escapeHtml(b.related || '')}" ${disabled} style="${readonlyStyle}" />

      <label>ä¸å…·åˆåŸå› ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
      <textarea id="detail-cause" rows="4" ${disabled} style="${readonlyStyle}">${escapeHtml(b.cause || '')}</textarea>

      <label>ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
      <textarea id="detail-fixplan" rows="4" ${disabled} style="${readonlyStyle}">${escapeHtml(b.fixPlan || '')}</textarea>

      <label>å½±éŸ¿ç¯„å›²ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
      <textarea id="detail-impact" rows="4" ${disabled} style="${readonlyStyle}">${escapeHtml(b.impact || '')}</textarea>

      <label>å‚™è€ƒï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
      <textarea id="detail-note" rows="4" ${disabled} style="${readonlyStyle}">${escapeHtml(b.note || '')}</textarea>

      <h3 style="margin-top:16px;">å¤‰æ›´å±¥æ­´</h3>
      <div id="detail-history" style="font-size:13px; color:#cbd5e1; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; max-height:200px; overflow:auto;"></div>
    `;
  }

  //============================
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  //============================
  function toggleEditMode(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;
    
    isEditMode = true;
    renderDetailContent(b, true);
    renderHistory(b);
  }

  //============================
  // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  //============================
  function cancelEdit(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;
    
    isEditMode = false;
    renderDetailContent(b, false);
    renderHistory(b);
  }

  //============================
  // æ–°è¦ç™»éŒ² - å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  //============================
  function addBug() {
    if (!currentUser) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      return;
    }

    // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    const title = document.getElementById('new-title').value.trim();
    const status = document.getElementById('new-status').value;
    const assignee = document.getElementById('new-assignee').value.trim();
    const severity = document.getElementById('new-severity').value;
    const priority = document.getElementById('new-priority').value;

    if (!title) {
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!status) {
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!assignee) {
      alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!severity) {
      alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    if (!priority) {
      alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const b = {
      id: 'b_' + Math.random().toString(36).slice(2, 9) + '_' + Date.now(),
      title: title,
      description: document.getElementById('new-desc').value,
      status: status,
      labels: document.getElementById('new-labels').value.split(',').map(x => x.trim()).filter(Boolean),
      reporter: currentUser.userId,
      reporterName: currentUser.userName,
      assignee: assignee,
      severity: severity,
      priority: priority,
      reproducibility: document.getElementById('new-repro').value,
      environment: document.getElementById('new-env').value,
      version: document.getElementById('new-version').value,
      related: document.getElementById('new-related').value,
      cause: '',
      fixPlan: '',
      impact: '',
      note: '',
      comments: [],
      history: [{ 
        type: 'create', 
        at: new Date().toISOString(), 
        user: currentUser.userName,
        data: {} 
      }],
      createdAt: new Date().toISOString()
    };

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        loadBugsFromServer();
      })
      .catch(e => {
        hideLoading();
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      });
  }
</script>

</body>

</html>
